<?xml version="1.0"?>
<addon scheme="3.0">
    <id>maxma_sync</id>
    <version>1.0</version>
    <priority>10000</priority>
    <position>0</position>
    <default_language>ru</default_language>
    <status>active</status>
    <name>MAXMA</name>
    <supplier>Exikane</supplier>
    <description>Интеграция с сервисом Maxma</description>
    <language_variables>
        <item id="maxma" lang="ru">Maxma</item>
        <item id="maxma_sync.balance_updated" lang="ru">Баланс баллов пользователей был успешно обновлен</item>
        <item id="'maxma_sync.queue_synced" lang="ru">Очередь была успешно обработана</item>
        <item id="maxma_sync.process_queue" lang="ru"> Для обработки очереди запросов нажмите -
            &lt;a class="cm-ajax cm-comet btn btn-primary" href="[process_queue_url]"&gt;
            Обработать очередь сейчас
            &lt;/a&gt;
            &lt;br /&gt;&lt;br /&gt;
        </item>
        <item id="maxma_sync.update_balances" lang="ru"> Для обновления баланса бонусных баллов пользователей нажмите -
            &lt;a class="cm-ajax cm-comet btn btn-primary" href="[update_balances_url]"&gt;
            Обновить баланс пользователей
            &lt;/a&gt;
            &lt;br /&gt;&lt;br /&gt;
        </item>
    </language_variables>

    <settings edition_type="ROOT">
        <sections>
            <section id="general">
                <items>
                    <item id="information">
                        <type>header</type>
                        <name>Настройки интеграции</name>
                    </item>
                    <item id="sync_queue">
                        <type>info</type>
                        <handler>fn_maxma_sync_queue</handler>
                    </item>
                    <item id="update_balances">
                        <type>info</type>
                        <handler>fn_maxma_sync_update_balances</handler>
                    </item>
                    <item id="api_key">
                        <type>input</type>
                        <name>API Key</name>
                    </item>
                    <item id="maxma_test_mode">
                        <type>checkbox</type>
                        <name>Test mode</name>
                    </item>
                    <item id="maxma_cache_ttl">
                        <type>input</type>
                        <default_value>120</default_value>
                        <name>Срок хранения информации о бонусах пользователя в кеше (в секундах)</name>
                    </item>
                    <item id="maxma_shop_code">
                        <type>input</type>
                        <default_value>CSCart</default_value>
                        <name>Код магазина (под этим кодом будут размещаться заказы и регистрироваться покупатели в Maxma)</name>
                    </item>
                    <item id="maxma_shop_name">
                        <type>input</type>
                        <default_value>CS-Cart</default_value>
                        <name>Наименование магазина в Maxma</name>
                    </item>
                    <item id="maxma_confirm_statuses">
                        <type>input</type>
                        <default_value>C</default_value>
                        <name>Статусы заказа для подтверждения заказов в Maxma</name>
                    </item>
                    <item id="maxma_confirm_cancel">
                        <type>input</type>
                        <default_value>I</default_value>
                        <name>Статусы заказа для отмены заказов в Maxma</name>
                    </item>
                    <item id="maxma_return_statuses">
                        <type>input</type>
                        <default_value>E</default_value>
                        <name>Статусы заказа для возврата заказов в Maxma</name>
                    </item>
                </items>
            </section>
        </sections>
    </settings>
    <queries>
        <item for="install">
            CREATE TABLE ?:maxma_queue (
            id mediumint(8) unsigned NOT NULL auto_increment,
            type varchar(64) NOT NULL DEFAULT '',           -- client_create | order_set | order_confirm | order_cancel | order_return
            entity_id mediumint(8) unsigned NOT NULL DEFAULT '0', -- user_id или order_id
            payload text NOT NULL,                          -- JSON с данными для MAXMA
            status varchar(16) NOT NULL DEFAULT 'new',     -- new | processing | done | error
            created_at int(11) unsigned NOT NULL DEFAULT '0',
            updated_at int(11) unsigned NOT NULL DEFAULT '0',
            PRIMARY KEY (id),
            INDEX idx_status (status),
            INDEX idx_type_entity (type, entity_id)
            ) ENGINE=MyISAM DEFAULT CHARSET UTF8;
        </item>
        <item for="install">
            CREATE TABLE ?:maxma_user_cache (
            user_id INT NOT NULL PRIMARY KEY,
            balance TEXT DEFAULT NULL,
            history TEXT DEFAULT NULL,
            updated_at INT DEFAULT 0
            );
        </item>
        <item for="install">ALTER TABLE ?:orders ADD maxma_promotion_data TEXT NOT NULL</item>
        <item for="uninstall">ALTER TABLE ?:orders DROP COLUMN maxma_promotion_data</item>
    </queries>
</addon>
